<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/all.min.css">
  <link rel="stylesheet" href="./css/output.css">
  <title>Whatsapp Sender</title>
</head>

<body class="grid grid-cols-1 md:grid-cols-2 h-screen">
  <section class="flex bg-slate-50 h-full  overflow-y-auto md:overflow-hidden">
    <div class="w-full flex flex-col justify-between p-8 bg-white h-full">
      <nav class="flex flex-col md:flex-row items-center justify-between">
        <a href="#" class="flex items-center gap-2">
          <img src="./img/whatsapp.webp" alt="Whatsapp" class="w-10">
          <span class="font-bold text-lg">Whatsapp Sender</span>
        </a>
        <ul class="flex gap-5 text-sm">
          <li class="font-medium text-slate-800"><i class="fa-solid fa-message mr-1"></i> Chat</li>
          <li class="text-slate-700">BOT</li>
          <li class="text-slate-700">Tutorial</li>
        </ul>
      </nav>
      <!-- Chat -->
      <main>
        <form action="#" class="space-y-5">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <label for="contact" class="block mb-2 text-sm font-medium text-gray-900">Kontak</label>
              <input type="file" id="contact" accept=".csv, .txt"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-xl focus:ring-blue-500 focus:border-blue-500 block w-full px-4 py-3"
                required>
              <div class="bg-gray-50 border border-gray-300 text-gray-900 px-3 py-1 text-xs rounded-lg mt-1 space-y-1">
                <div>
                  <span class="text-slate-800 font-bold">Contoh:</span>
                  <code class="text-slate-800">nama 1,081233123777,abc123,...</code>
                </div>
              </div>
              <p id="contact-helper" class="mt-2 text-xs text-red-600">Masukan file kontak dengan format .txt / .csv</p>
            </div>
            <div>
              <label for="media" class="block mb-2 text-sm font-medium text-gray-900">Media</label>
              <input type="file" id="media"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-xl focus:ring-blue-500 focus:border-blue-500 block w-full px-4 py-3">
              <p id="media-helper" class="mt-2 text-xs text-red-600">Unggah berkas dengan contoh: .pdf</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-5">
            <div>
              <label for="pmb" class="block mb-2 text-sm font-medium text-gray-900">PMB</label>
              <input type="number" id="pmb"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-xl focus:ring-blue-500 focus:border-blue-500 block w-full px-4 py-3"
                placeholder="Tahun PMB" required>
              <p id="pmb-helper" class="mt-2 text-xs text-red-600">Otomatis mengikuti PMB.</p>
            </div>
            <div>
              <label for="title" class="block mb-2 text-sm font-medium text-gray-900">Judul Pesan</label>
              <input type="text" id="title" value="Perkenalan"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-xl focus:ring-blue-500 focus:border-blue-500 block w-full px-4 py-3"
                placeholder="Judul Pesan" required>
                <p id="title-helper" class="mt-2 text-xs text-red-600">Penting! Ganti judul sekarang.</p>
            </div>
          </div>
          <div class="grid grid-cols-1 gap-3">
            <div class="text-xl cursor-pointer" id="emoticon">
              <span>✅</span>
              <span>🇲🇨</span>
              <span>👋</span>
              <span>🙌</span>
              <span>🤲</span>
              <span>🤝</span>
              <span>🥳</span>
              <span>😱</span>
              <span>🤩</span>
              <span>😊</span>
              <span>😉</span>
              <span>🤗</span>
              <span>👇</span>
              <span>👍</span>
              <span>✨</span>
              <span>📍</span>
              <span>😂</span>
              <span>💪🏻</span>
              <span>🙏</span>
              <span>1️⃣</span>
              <span>2️⃣</span>
              <span>3️⃣</span>
              <span>4️⃣</span>
              <span>5️⃣</span>
            </div>
            <div class="flex flex-wrap gap-2">
              <div id="add-fullname"
                class="cursor-pointer text-center text-xs py-1 px-3 text-sm text-white rounded-lg bg-red-600 hover:bg-red-700">
                <i class="fa-solid fa-circle-plus mr-1"></i><i class="fa-solid fa-address-card"></i> Nama
              </div>
              <div id="add-firstname"
                class="cursor-pointer text-center text-xs py-1 px-3 text-sm text-white rounded-lg bg-red-600 hover:bg-red-700">
                <i class="fa-solid fa-circle-plus mr-1"></i><i class="fa-solid fa-address-card"></i> Firstname
              </div>
              <div id="add-whatsapp"
                class="cursor-pointer text-center text-xs py-1 px-3 text-sm text-white rounded-lg bg-red-600 hover:bg-red-700">
                <i class="fa-solid fa-circle-plus mr-1"></i><i class="fa-brands fa-whatsapp"></i> Whatsapp
              </div>
              <div id="add-var1"
                class="cursor-pointer text-xs py-1 px-3 text-sm text-white rounded-lg bg-emerald-500 hover:bg-emerald-600">
                <i class="fa-solid fa-tag"></i> 1
              </div>
              <div id="add-var2"
                class="cursor-pointer text-xs py-1 px-3 text-sm text-white rounded-lg bg-emerald-500 hover:bg-emerald-600">
                <i class="fa-solid fa-tag"></i> 2
              </div>
              <div id="add-var3"
                class="cursor-pointer text-xs py-1 px-3 text-sm text-white rounded-lg bg-emerald-500 hover:bg-emerald-600">
                <i class="fa-solid fa-tag"></i> 3
              </div>
              <div id="add-var4"
                class="cursor-pointer text-xs py-1 px-3 text-sm text-white rounded-lg bg-emerald-500 hover:bg-emerald-600">
                <i class="fa-solid fa-tag"></i> 4
              </div>
              <div id="add-var5"
                class="cursor-pointer text-xs py-1 px-3 text-sm text-white rounded-lg bg-emerald-500 hover:bg-emerald-600">
                <i class="fa-solid fa-tag"></i> 5
              </div>
              <div id="add-var6"
                class="cursor-pointer text-xs py-1 px-3 text-sm text-white rounded-lg bg-emerald-500 hover:bg-emerald-600">
                <i class="fa-solid fa-tag"></i> 6
              </div>
            </div>
            <div class="flex items-center gap-5">
              <div class="w-full">
                <label for="media" class="block mb-2 text-sm font-medium text-gray-900">Media</label>
                <textarea id="media" rows="4"
                  class="block px-4 py-3 w-full text-sm text-gray-900 bg-gray-50 rounded-xl border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Tulis pesan disini..." required></textarea>
              </div>
              <div class="w-1/3 text-sm">
                <span class="text-slate-800 font-bold">Panduan:</span><br>
                <span id="text-italic" class="cursor-pointer text-slate-800">Miring
                  <code><i>_teks_</i></code></span><br>
                <span id="text-bold" class="cursor-pointer text-slate-800">Tebal <code><b>*teks*</b></code></span><br>
                <span id="text-strike" class="cursor-pointer text-slate-800">Coretan
                  <code><s>~teks~</s></code></span><br>
              </div>
            </div>
            <button type="submit"
              class="bg-sky-500 hover:bg-sky-600 text-white py-2 px-5 rounded-xl text-sm"><i class="fa-solid fa-paper-plane mr-1"></i> Kirim</button>
          </div>
        </form>
      </main>
      <!-- End Chat -->
      <!-- Authentication -->
      <main class="hidden space-y-5">
        <div class="space-y-2">
          <h2 class="font-bold text-4xl leading-snug">Simple. New Version.<br />Reliable Messaging for Marketing.</h2>
          <p class="text-gray-700">Lorem ipsum dolor sit amet consectetur adipisicing elit. Cum, molestiae doloremque?
            Asperiores laboriosam voluptate voluptas dolorem autem corrupti sapiente reprehenderit?</p>
        </div>
        <div class="hidden flex items-center gap-5">
          <input type="number" id="identity" placeholder="Tulis kode ID anda disini..."
            class="w-full bg-slate-50 border border-slate-300 px-5 py-4 rounded-2xl text-sm">
          <button onclick="setIdentity()"
            class="flex items-center gap-2 px-5 py-4 bg-[#25D366] hover:bg-[#24C861] text-white rounded-2xl text-sm">
            <i class="fa-solid fa-right-to-bracket"></i> Masuk</button>
        </div>
        <div class="hidden">
          <lottie-player src="./animation/loading.json" background="transparent" speed="1"
            style="width: 100px; height: 100px;" loop autoplay></lottie-player>
        </div>
        <div class="hidden space-y-3">
          <img src="./img/qrcode-sample.png" alt="QR Code" id="qrcode" class="w-48 border border-gray-200">
          <div class="text-xs text-gray-700">Jika terjadi <span class="font-medium text-red-600">"Tidak dapat menautkan
              perangkat"</span> maka <span class="text-emerald-600">tunggu sampai QR Code</span> berubah.</div>
        </div>
      </main>
      <!-- End Authentication -->
      <footer class="flex items-center justify-between">
        <p class="text-xs text-gray-600">Copyright © 2023 Lerian Febriana, A.Md.Kom</p>
        <ul class="flex items-center gap-3">
          <li class="text-xs text-gray-600">
            <a href="https://instagram.com/kanglerian" target="_blank"><i class="fa-brands fa-instagram"></i>
              Instagram</a>
          </li>
          <li class="text-xs text-gray-600">
            <a href="https://wa.me/6281286501015" target="_blank"><i class="fa-solid fa-circle-info"></i> Help</a>
          </li>
        </ul>
      </footer>
    </div>
  </section>
  <section id="chat-container" class="flex justify-center items-center bg-[#25D366] h-full overflow-hidden">
    <div class="flex flex-col justify-center items-center h-full">
      <div class="text-center space-y-3">
        <i class="fa-brands fa-whatsapp fa-3x text-white"></i>
        <div id="signal" class="text-white"></div>
      </div>
    </div>
  </section>
  <script src="./js/all.min.js"></script>
  <script src="./js/axios.min.js"></script>
  <script src="./js/jquery-3.7.0.min.js"></script>
  <script src="./js/lottie-player.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const accounts = localStorage.getItem('accounts');
    const parsedData = JSON.parse(accounts);
    const socket = io('http://localhost:7001')

    socket.on('connect', () => {
      let icon = '<i class="fa-solid fa-server mr-1"></i>'
      let text = '<span class="text-sm">Terhubung ke server.</span>'
      $('#chat-container').css('background-color', '#25D366');
      $('#signal').css('display', 'block').html(`<span>${icon} ${text}</span>`);
      $('#loading-container').show();
      console.log('Terhubung ke server');
    });

    socket.on('connect_error', (error) => {
      let icon = '<i class="fa-solid fa-server mr-1"></i>'
      let text = '<span class="text-sm">Gagal terhubung ke server.</span>'
      $('#chat-container').css('background-color', '#ef4444');
      $('#signal').css('display', 'block').html(`<span>${icon} ${text}</span>`);
      $('#qrcode-container').hide();
      $('#loading-container').show();
      console.log('Gagal terhubung ke server');
    });

    socket.on('ready', (data) => {
      $('#qrcode-container').hide();
      getUser();
      setTimeout(() => {
        getData();
      }, 1000);
    })

    socket.on('qrcodeval', (qrcode) => {
      getUser();
      document.getElementById('qrcode').src = qrcode;
      $('#qrcode-container').show();
      $('#loading-container').hide();
    })

    const setIdentity = async () => {
      let identity = document.getElementById('identity').value;
      await axios.get(`https://database.politekniklp3i-tasikmalaya.ac.id/api/user/info/${identity}`)
        .then((response) => {
          if (response.data.name !== "Tidak diketahui") {
            socket.emit('setIdentity', identity);
            getUser();
          } else {
            alert('Akun Tidak Ditemukan.')
          }
        })
        .catch((error) => {
          console.log(error);
        });
    }

    const getUser = () => {
      socket.emit('getUsers', true);
      socket.on('users', (data) => {
        localStorage.setItem('accounts', JSON.stringify(data));
        let code = data.code;
        if (code) {
          $('#identity-container').hide();
          if (data.status == 1) {
            $('#loading-container').hide();
          } else {
            $('#loading-container').show();
          }
        } else {
          $('#identity-container').show();
        }
        console.log(data.status);
      });
      socket.emit('getHistory', true);
      socket.on('histories', (data) => {
        localStorage.setItem('histories', JSON.stringify(data));
      });
    }

    getUser();

    const getData = async () => {
      const accounts = localStorage.getItem('accounts');
      const parsedData = JSON.parse(accounts);
      const histories = localStorage.getItem('histories');
      const parsedHistories = JSON.parse(histories);

      const presenter = await checkAPI(parsedData.phone);
      const gurubk = await checkGuruBK();

      // let bucket = '';

      // if (parsedHistories.length > 0) {
      //   parsedHistories.forEach((contact, i) => {
      //     bucket += `
      //     <tr>
      //       <th scope="row" class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap">${i + 1}</th>
      //       <td class="px-6 py-2">${contact.name}</td>
      //       <td class="px-4 py-2">${contact.phone}</td>
      //       <td class="px-3 py-2">${contact.status == 1 ? `<i class="text-green-500 fas fa-check-circle"></i>` : '<i class="text-red-500 fas fa-circle-xmark"></i>'}</td>
      //     </tr>
      //   `
      //   });
      // } else {
      //   bucket += `<tr><td colspan="4" class="text-center text-gray-600 py-3 text-sm">Data riwayat belum ada</td></tr>`
      // }
      // if (presenter.length > 0 || gurubk.status) {
      //   if (parsedData.status == 0 && parsedData.qrcode == null) {
      //     $('#splashTitle').text(`Menunggu QRCode`)
      //     $('#splashParagraph').text(`"Barang siapa yang berusaha bersabar, maka Allah akan menjadikannya bisa bersabar dan tidak ada seorang pun yang dianugerahi sesuatu yang melebihi kesabaran." (HR. Bukhari No 1469)`)
      //     $('#accountContainer').hide()
      //     $('#mainContainer').hide()
      //     $('#loadingContainer').show()
      //     $('#qrcodeContainer').hide()
      //     $('#identityContainer').hide()
      //   } else if (parsedData.status == 0 && parsedData.qrcode != null) {

      //     $('#qrcode').attr('src', parsedData.qrcode);
      //     $('#splashTitle').text(`Silahkan Scan QRCode`)
      //     $('#splashParagraph').text(`"Barangsiapa bertakwa kepada Allah niscaya Dia akan memberikan jalan keluar, dan memberinya rizki dari arah yang tidak disangka. Dan barangsiapa yang bertawakkal kepada Allah niscaya Allah akan mencukupkan (keperluan)nya." (QS. Ath Thalaaq [65] : 2-3)`)
      //     $('#splashContainer').show()
      //     $('#accountContainer').hide()
      //     $('#mainContainer').hide()
      //     $('#loadingContainer').hide()

      //     if (parsedData.code) {
      //       $('#qrcodeContainer').show()
      //       $('#splashContainer').show()
      //       $('#identityContainer').hide()
      //     } else {
      //       $('#qrcodeContainer').hide()
      //       $('#splashContainer').hide()
      //       $('#identityContainer').show()
      //     }

      //   } else if (parsedData.status == 1) {

      //     let name;

      //     try {
      //       const response = await axios.get(`https://database.politekniklp3i-tasikmalaya.ac.id/api/user/info/${parsedData.code}`);
      //       name = response.data.name;
      //     } catch (error) {
      //       name = error.message;
      //     }

      //     $('#identityContainer').hide()
      //     $('#splashContainer').hide()
      //     $('#accountContainer').hide()
      //     $('#loadingContainer').hide()
      //     $('#qrcodeContainer').hide()
      //     $('#mainContainer').show()
      //     $('#navbarContainer').show()
      //     $('#history').html(bucket);
      //     $('#info_identity').html(`
      //       <i class="fa-solid fa-circle-user text-sky-500"></i>
      //       <p class="inline text-sm text-gray-900">
      //         Halo <span class="underline font-bold">${name}</span>
      //       </p>
      //       <p class="text-sm text-gray-900 mt-1">
      //         ${parsedData.phone} sedang aktif!
      //       </p>
      //     `);
      //   }
      // } else {
      //   $('#accountContainer').show()
      //   $('#splashContainer').hide()
      // }
    }

    const checkAPI = async (phone) => {
      try {
        const response = await axios.get(`https://whatsapp-account-lp3i.vercel.app/api/accounts/${phone}`);
        return response.data;
      } catch (error) {
        console.error(error);
      }
    }

    const checkGuruBK = async () => {
      try {
        const response = await axios.get(`https://whatsapp-account-lp3i.vercel.app/api/gurubk`);
        return response.data;
      } catch (error) {
        console.error(error);
      }
    }
  </script>
</body>

</html>